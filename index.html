<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>咪仔織譜秘笈</title>
    <style>
        :root { --p: #efa8b8; --s: #8fb6d9; --bg: #fdfafb; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        
        .header-box { background: white; padding: 20px 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { margin: 0; color: #d48a9a; letter-spacing: 2px; font-size: 1.4rem; }
        
        .tabs { display: flex; margin: 15px auto 0; max-width: 300px; background: #eee; border-radius: 20px; padding: 3px; }
        .tab { flex: 1; padding: 8px; cursor: pointer; border-radius: 17px; font-size: 13px; text-align: center; color: #777; transition: 0.3s; }
        .tab.active { background: white; color: #d48a9a; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; background: #f0f0f0; }
        .card-title { padding: 10px; font-size: 14px; text-align: center; font-weight: bold; color: #444; }

        /* 彈窗詳情頁 */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; overflow-y: auto; }
        .view-content { padding: 0 0 40px 0; }
        .img-slider { display: flex; overflow-x: auto; snap-type: x mandatory; background: #000; height: 350px; }
        .img-slider img { flex: 0 0 100%; object-fit: contain; snap-align: start; }
        .content-box { padding: 20px; }
        .label { color: #d48a9a; font-weight: bold; font-size: 13px; margin-top: 20px; display: block; border-left: 3px solid #d48a9a; padding-left: 8px; }
        .text-display { margin-top: 8px; font-size: 15px; line-height: 1.6; color: #333; white-space: pre-wrap; background: #fff; }

        /* 編輯表單樣式 */
        .edit-mode { display: none; padding: 20px; }
        input, textarea, select { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .img-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .img-thumb { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 5px; }

        /* 底部按鈕 */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; border-top: 1px solid #eee; background: white; }
        .nav-btn { flex: 1; padding: 15px; text-align: center; font-weight: bold; border: none; background: none; font-size: 15px; cursor: pointer; }
        .btn-edit { color: #d48a9a; }
        .btn-close { color: #999; }
        .btn-save { background: #d48a9a; color: white; }
        
        .fab { position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px; background: #d48a9a; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; border: none; box-shadow: 0 4px 12px rgba(212,138,154,0.4); z-index: 99; }
    </style>
</head>
<body>

<div class="header-box">
    <h2>咪仔織譜秘笈</h2>
    <div class="tabs">
        <div class="tab active" id="tab-钩针" onclick="switchTab('鉤針')">鉤針</div>
        <div class="tab" id="tab-棒针" onclick="switchTab('棒針')">棒針</div>
    </div>
</div>

<div class="grid" id="project-grid"></div>
<button class="fab" onclick="openAdd()">+</button>

<div id="modal">
    <div id="view-mode" class="view-content">
        <div id="view-slider" class="img-slider"></div>
        <div class="content-box">
            <h1 id="view-title" style="margin:0 0 10px 0; font-size: 22px;"></h1>
            <span id="view-type-tag" style="background:#eee; padding:3px 10px; border-radius:10px; font-size:12px;"></span>
            
            <span class="label">製作步驟</span>
            <div id="view-steps" class="text-display"></div>
            
            <span class="label">備註資訊</span>
            <div id="view-notes" class="text-display"></div>
        </div>
        <div class="bottom-nav">
            <button class="nav-btn btn-close" onclick="closeModal()">返回列表</button>
            <button class="nav-btn btn-edit" onclick="enterEditMode()">編輯內容</button>
        </div>
    </div>

    <div id="edit-mode" class="edit-mode">
        <h3 id="edit-header">編輯作品</h3>
        <input type="text" id="m-title" placeholder="作品名稱">
        <select id="m-type">
            <option value="鉤針">類別：鉤針</option>
            <option value="棒針">類別：棒針</option>
        </select>
        <p style="font-size:12px; color:#999; margin:10px 0 5px;">選擇圖片（最多5張，首張為封面）</p>
        <input type="file" id="m-img" accept="image/*" multiple onchange="handleImgs(this)">
        <div id="edit-img-preview" class="img-grid"></div>
        
        <textarea id="m-steps" rows="8" placeholder="製作步驟 (R1, R2...)"></textarea>
        <textarea id="m-notes" rows="4" placeholder="線材、針號備註"></textarea>
        
        <button class="btn-save" style="width:100%; padding:15px; border-radius:10px; border:none; margin-top:10px;" onclick="saveData()">儲存並發佈</button>
        <button id="del-btn" style="width:100%; background:none; border:none; color:red; margin-top:15px;" onclick="deleteData()">刪除此作品</button>
        <button style="width:100%; background:none; border:none; color:#999; margin-top:10px;" onclick="exitEditMode()">取消編輯</button>
    </div>
</div>

<script>
    let projects = JSON.parse(localStorage.getItem('mizai_db_v4')) || [];
    let currentType = '鉤針';
    let editingId = null;
    let tempImgs = []; // 存儲多張Base64圖片

    function switchTab(type) {
        currentType = type;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText === type));
        renderWall();
    }

    function renderWall() {
        const grid = document.getElementById('project-grid');
        const list = projects.filter(p => p.type === currentType);
        grid.innerHTML = list.map(p => `
            <div class="card" onclick="openDetail(${p.id})">
                <img src="${(p.imgs && p.imgs[0]) || 'https://via.placeholder.com/150?text=No+Photo'}" class="card-img">
                <div class="card-title">${p.title}</div>
            </div>
        `).join('');
    }

    function openDetail(id) {
        editingId = id;
        const p = projects.find(item => item.id === id);
        
        // 填充檢視模式內容
        document.getElementById('view-
