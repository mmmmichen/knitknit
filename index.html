<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å’ªä»”ç¹”è­œç§˜ç¬ˆ</title>
    <style>
        :root { --p: #efa8b8; --text: #333; }
        body { font-family: -apple-system, sans-serif; background: #fafafa; margin: 0; padding-bottom: 80px; color: var(--text); -webkit-tap-highlight-color: transparent; }
        
        /* æ¨™é¡Œèˆ‡åˆ†é  */
        .header-box { background: white; padding: 20px 15px 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0 0 12px 0; font-size: 1.3rem; color: #444; letter-spacing: 1px; }
        .tabs { display: flex; border-radius: 20px; overflow: hidden; background: #eee; padding: 3px; }
        .tab { flex: 1; padding: 10px; cursor: pointer; border-radius: 18px; font-size: 14px; text-align: center; transition: 0.2s; }
        .tab.active { background: #333; color: white; font-weight: bold; }

        /* ä½œå“ç‰† */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #f0f0f0; display: block; }
        .card-info { padding: 10px; text-align: center; font-size: 14px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* ä¸»è¦å½ˆçª— (ç€è¦½/ç·¨è¼¯) */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; z-index: 10; }
        .modal-body { padding: 20px; padding-bottom: 60px; }

        /* åœ–ç‰‡æ”¾å¤§æª¢è¦– (Lightbox) */
        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        #lightbox-img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .lightbox-hint { position: absolute; bottom: 20px; color: white; font-size: 14px; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; }

        /* ç€è¦½æ¨¡å¼æ¨£å¼ */
        .view-title { font-size: 1.5rem; margin-bottom: 15px; font-weight: bold; color: #222; }
        .view-section { margin-bottom: 25px; }
        .view-label { font-size: 13px; color: var(--p); font-weight: bold; margin-bottom: 8px; display: block; }
        .view-content { line-height: 1.7; white-space: pre-wrap; font-size: 16px; background: #fcfcfc; padding: 12px; border-radius: 10px; border: 1px solid #eee; color: #444; }
        
        /* åœ–ç‰‡å±•ç¤ºå€ */
        .img-gallery { display: flex; gap: 12px; overflow-x: auto; padding: 5px; margin-bottom: 20px; }
        /* ç€è¦½æ¨¡å¼çš„åœ–ç‰‡ (å¯é»æ“Š) */
        .view-gallery-item { width: 130px; height: 130px; flex-shrink: 0; object-fit: cover; border-radius: 12px; border: 1px solid #eee; background: #f9f9f9; cursor: zoom-in; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        /* ç·¨è¼¯æ¨¡å¼çš„é è¦½åœ– (ä¸å¯é»æ“Š) */
        .edit-gallery-item { width: 100px; height: 100px; flex-shrink: 0; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; opacity: 0.8; }

        /* ç·¨è¼¯æ¨¡å¼è¡¨å–® */
        label { font-size: 13px; color: #999; font-weight: bold; margin-top: 15px; display: block; }
        input, textarea, select { width: 100%; margin: 8px 0; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #fafafa; outline: none; }
        input:focus, textarea:focus { border-color: var(--p); background: white; }
        
        /* æŒ‰éˆ•ç³»çµ± */
        .btn-round { padding: 8px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-edit { background: var(--p); color: white; box-shadow: 0 2px 5px rgba(239,168,184,0.4); }
        .btn-cancel { background: #eee; color: #666; }
        .btn-save { background: #333; color: white; width: 100%; padding: 15px; font-size: 16px; margin-top: 20px; border-radius: 12px; font-weight: bold; }
        .btn-close { background: none; font-size: 28px; color: #999; border: none; padding: 0 10px; }
        
        .fab { position: fixed; bottom: 30px; right: 25px; width: 60px; height: 60px; background: var(--p); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; box-shadow: 0 4px 15px rgba(239,168,184,0.4); z-index: 500; transition: transform 0.2s; }
        .fab:active { transform: scale(0.95); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="header-box">
    <h1>ğŸ§¶ å’ªä»”ç¹”è­œç§˜ç¬ˆ</h1>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('é‰¤é‡')">é‰¤é‡ä½œå“</div>
        <div class="tab" onclick="switchTab('æ£’é‡')">æ£’é‡ä½œå“</div>
    </div>
</div>

<div class="grid" id="project-grid"></div>
<button class="fab" onclick="openAdd()">+</button>

<div id="lightbox" onclick="closeLightbox()">
    <img id="lightbox-img" src="" onclick="event.stopPropagation()"> <div class="lightbox-hint">é»æ“ŠèƒŒæ™¯é—œé–‰</div>
</div>

<div id="modal">
    <div class="modal-header">
        <button class="btn-close" onclick="closeModal()">Ã—</button>
        <div id="modal-nav-btns"></div>
    </div>

    <div class="modal-body">
        <div id="view-mode">
            <div id="v-imgs" class="img-gallery"></div>
            <div id="v-title" class="view-title"></div>
            <div class="view-section">
                <span class="view-label">è£½ä½œæ­¥é©Ÿ</span>
                <div id="v-steps" class="view-content"></div>
            </div>
            <div class="view-section">
                <span class="view-label">å‚™è¨»</span>
                <div id="v-notes" class="view-content"></div>
            </div>
        </div>

        <div id="edit-mode" class="hidden">
            <label style="margin-top:0;">æ›´æ–°ç…§ç‰‡ (æœ€å¤š 3 å¼µ)ï¼š</label>
            <div id="e-img-preview" class="img-gallery" style="min-height: 100px; background: #f9f9f9; border-radius: 10px; align-items: center; padding: 10px;"></div>
            <input type="file" id="e-file" accept="image/*" multiple onchange="processImages(this)" style="margin-top:10px;">
            
            <label>ä½œå“åç¨±ï¼š</label>
            <input type="text" id="e-title">
            
            <label>é¡åˆ¥ï¼š</label>
            <select id="e-type">
                <option value="é‰¤é‡">é‰¤é‡</option>
                <option value="æ£’é‡">æ£’é‡</option>
            </select>
            
            <label>è£½ä½œæ­¥é©Ÿï¼š</label>
            <textarea id="e-steps" rows="10"></textarea>
            
            <label>å‚™è¨»ï¼š</label>
            <textarea id="e-notes" rows="4"></textarea>
            
            <button class="btn-save" id="save-btn" onclick="saveData()">å„²å­˜ä¿®æ”¹å…§å®¹</button>
            <button id="del-btn" style="width:100%; margin-top:30px; color:#ff7675; border:none; background:none; font-size:13px; padding: 10px;" onclick="deleteData()">åˆªé™¤é€™ä»½ç§˜ç¬ˆ</button>
        </div>
    </div>
</div>

<script>
    const DB_KEY = 'mizai_final_v9'; // æ›´æ–°ç‰ˆæœ¬è™Ÿä»¥å€éš”èˆŠè³‡æ–™
    let projects = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    let currentType = 'é‰¤é‡';
    let editingId = null;
    let tempImgs = []; 

    function switchTab(type) {
        currentType = type;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText === type + 'ä½œå“'));
        renderWall();
    }

    function renderWall() {
        const grid = document.getElementById('project-grid');
        const list = projects.filter(p => p.type === currentType);
        if (list.length === 0) {
            grid.innerHTML = `<div style="grid-column:1/3; text-align:center; padding:60px 0; color:#ccc; font-size:14px;">ç›®å‰æ²’æœ‰${currentType}ç´€éŒ„<br>é»æ“Šå³ä¸‹è§’ + æ–°å¢</div>`;
            return;
        }
        grid.innerHTML = list.map(p => `
            <div class="card" onclick="openDetail(${p.id})">
                <img src="${(p.imgs && p.imgs[0]) ? p.imgs[0] : 'https://via.placeholder.com/300?text=No+Photo'}" class="card-img" loading="lazy">
                <div class="card-info">${p.title}</div>
            </div>
        `).join('');
    }

    // æ‰“é–‹åœ–ç‰‡æ”¾å¤§æª¢è¦–
    function openLightbox(src) {
        document.getElementById('lightbox-img').src = src;
        document.getElementById('lightbox').style.display = 'flex';
    }
    function closeLightbox() {
        document.getElementById('lightbox').style.display = 'none';
    }

    function openDetail(id) {
        editingId = id;
        const p = projects.find(item => item.id === id);
        if (!p) return;

        // å¡«å……ç€è¦½å…§å®¹ (åŠ å…¥ onclick äº‹ä»¶ä»¥é–‹å•Ÿå¤§åœ–)
        document.getElementById('v-title').innerText = p.title;
        document.getElementById('v-steps').innerText = p.steps || "å°šç„¡æ­¥é©Ÿç´€éŒ„";
        document.getElementById('v-notes').innerText = p.notes || "å°šç„¡å‚™è¨»";
        document.getElementById('v-imgs').innerHTML = (p.imgs || []).map(src => 
            `<img src="${src}" class="view-gallery-item" onclick="openLightbox('${src}')">`
        ).join('');
        
        document.getElementById('modal-nav-btns').innerHTML = `<button class="btn-round btn-edit" onclick="toggleEditMode(true)">ç·¨è¼¯</button>`;
        
        toggleEditMode(false);
        document.getElementById('modal').style.display = 'block';
    }

    function toggleEditMode(isEdit) {
        const viewArea = document.getElementById('view-mode');
        const editArea = document.getElementById('edit-mode');
        const navBtns = document.getElementById('modal-nav-btns');

        if (isEdit) {
            viewArea.classList.add('hidden');
            editArea.classList.remove('hidden');
            navBtns.innerHTML = `<button class="btn-round btn-cancel" onclick="toggleEditMode(false)">å–æ¶ˆ</button>`;
            
            const p = projects.find(item => item.id === editingId) || { title:'', type:currentType, steps:'', notes:'', imgs:[] };
            document.getElementById('e-title').value = p.title;
            document.getElementById('e-type').value = p.type;
            document.getElementById('e-steps').value = p.steps;
            document.getElementById('e-notes').value = p.notes;
            tempImgs = p.imgs || [];
            updateEditPreview();
        } else {
            viewArea.classList.remove('hidden');
            editArea.classList.add('hidden');
            if (editingId) {
                navBtns.innerHTML = `<button class="btn-round btn-edit" onclick="toggleEditMode(true)">ç·¨è¼¯</button>`;
            }
        }
    }

    function openAdd() {
        editingId = null;
        tempImgs = [];
        toggleEditMode(true);
        document.getElementById('e-title').value = "";
        document.getElementById('e-steps').value = "";
        document.getElementById('e-notes').value = "";
        updateEditPreview();
        document.getElementById('del-btn').style.display = 'none';
        document.getElementById('modal').style.display = 'block';
    }

    // åœ–ç‰‡è™•ç† (æå‡ç•«è³ª)
    async function processImages(input) {
        const files = Array.from(input.files).slice(0, 3);
        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        saveBtn.innerText = "é«˜ç•«è³ªè™•ç†ä¸­...";
        saveBtn.style.opacity = 0.7;

        tempImgs = []; 
        for (let file of files) {
            const base64 = await new Promise(resolve => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // æå‡è§£æåº¦è‡³ 600px
                        const MAX_WIDTH = 600;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * (MAX_WIDTH / img.width);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // æå‡ç•«è³ªè‡³ 0.7
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
            tempImgs.push(base64);
        }
        updateEditPreview();
        saveBtn.disabled = false;
        saveBtn.innerText = "å„²å­˜ä¿®æ”¹å…§å®¹";
        saveBtn.style.opacity = 1;
    }

    function updateEditPreview() {
        const box = document.getElementById('e-img-preview');
        box.innerHTML = tempImgs.map(src => `<img src="${src}" class="edit-gallery-item">`).join('') || '<span style="color:#ccc; font-size:13px;">(å°šæœªé¸æ“‡ç…§ç‰‡)</span>';
    }

    function saveData() {
        const title = document.getElementById('e-title').value.trim();
        if (!title) { alert("è«‹å¡«å¯«ä½œå“åç¨±"); return; }

        const data = {
            id: editingId || Date.now(),
            title: title,
            type: document.getElementById('e-type').value,
            steps: document.getElementById('e-steps').value,
            notes: document.getElementById('e-notes').value,
            imgs: tempImgs
        };

        try {
            if (editingId) {
                const idx = projects.findIndex(p => p.id === editingId);
                projects[idx] = data;
            } else {
                projects.push(data);
            }
            localStorage.setItem(DB_KEY, JSON.stringify(projects));
            openDetail(data.id);
            renderWall();
        } catch (e) {
            alert("å„²å­˜å¤±æ•—ï¼šå¯èƒ½æ˜¯ç…§ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹å˜—è©¦æ¸›å°‘ç…§ç‰‡æ•¸é‡ã€‚");
        }
    }

    function deleteData() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½ç§˜ç¬ˆå—ï¼Ÿ")) {
            projects = projects.filter(p => p.id !== editingId);
            localStorage.setItem(DB_KEY, JSON.stringify(projects));
            closeModal();
            renderWall();
        }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    renderWall();
</script>

</body>
</html>
