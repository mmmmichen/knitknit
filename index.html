<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å’ªä»”ç¹”è­œç§˜ç¬ˆ</title>
    <style>
        :root { --p: #efa8b8; --s: #8fb6d9; --bg: #fdfdfd; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: #333; }
        
        /* Header & Tabs */
        .header-box { background: white; padding: 20px 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0 0 15px 0; font-size: 1.4rem; color: #444; letter-spacing: 1px; }
        .tabs { display: flex; border-radius: 20px; overflow: hidden; background: #eee; padding: 3px; }
        .tab { flex: 1; padding: 8px; cursor: pointer; border-radius: 18px; font-size: 14px; text-align: center; }
        .tab.active { background: #333; color: white; font-weight: bold; }

        /* Grid View */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 8px rgba(0,0,0,0.08); border: 1px solid #eee; }
        .card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #f0f0f0; display: block; }
        .card-info { padding: 8px; text-align: center; font-size: 13px; font-weight: 600; }

        /* Modal Details */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto; }
        .modal-content { padding: 20px; max-width: 600px; margin: auto; }
        
        /* Multi-Image Gallery */
        .img-gallery { display: flex; gap: 8px; overflow-x: auto; margin: 10px 0; padding: 5px 0; min-height: 80px; }
        .gallery-item { width: 100px; height: 100px; flex-shrink: 0; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        
        /* Form Styling */
        label { font-size: 12px; color: #888; font-weight: bold; margin-top: 15px; display: block; }
        input, textarea, select { width: 100%; margin: 5px 0 10px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fbfbfb; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        .btn { flex: 1; padding: 15px; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-save { background: #333; color: white; }
        .btn-save:disabled { background: #ccc; }
        .btn-cancel { background: #f0f0f0; color: #666; }
        
        .fab { position: fixed; bottom: 30px; right: 25px; width: 60px; height: 60px; background: var(--p); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 500; }
        #status-msg { font-size: 12px; color: var(--p); text-align: center; margin-bottom: 5px; display: none; }
    </style>
</head>
<body>

<div class="header-box">
    <h1>ğŸ§¶ å’ªä»”ç¹”è­œç§˜ç¬ˆ</h1>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('é‰¤é‡')">é‰¤é‡ä½œå“</div>
        <div class="tab" onclick="switchTab('æ£’é‡')">æ£’é‡ä½œå“</div>
    </div>
</div>

<div class="grid" id="project-grid"></div>
<button class="fab" onclick="openAdd()">+</button>

<div id="modal">
    <div class="modal-content">
        <h2 id="m-header" style="margin-top:0;">ç·¨è¼¯ç¹”è­œ</h2>
        
        <label>ä½œå“ç…§ç‰‡ (æœ€å¤š 5 å¼µ)ï¼š</label>
        <div id="img-gallery-box" class="img-gallery"></div>
        <div id="status-msg">åœ–ç‰‡å£“ç¸®ä¸­ï¼Œè«‹ç¨å€™...</div>
        <input type="file" id="m-img" accept="image/*" multiple onchange="processImages(this)">
        
        <label>ä½œå“åç¨±ï¼š</label>
        <input type="text" id="m-title" placeholder="è¼¸å…¥åç¨±...">
        
        <label>é¡åˆ¥ï¼š</label>
        <select id="m-type">
            <option value="é‰¤é‡">é‰¤é‡ (Crochet)</option>
            <option value="æ£’é‡">æ£’é‡ (Knitting)</option>
        </select>
        
        <label>è£½ä½œæ­¥é©Ÿï¼š</label>
        <textarea id="m-steps" rows="8" placeholder="å¡«å¯«è©³ç´°ç¹”æ³•..."></textarea>
        
        <label>å‚™è¨»ï¼š</label>
        <textarea id="m-notes" rows="4" placeholder="ç·šæã€é‡è™Ÿã€æ³¨æ„äº‹é …..."></textarea>
        
        <div class="btn-group">
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆè¿”å›</button>
            <button class="btn btn-save" id="save-btn" onclick="saveData()">å„²å­˜ç§˜ç¬ˆ</button>
        </div>
        <button id="del-btn" style="width:100%; margin-top:30px; color:#aaa; border:none; background:none; font-size:12px; text-decoration: underline;" onclick="deleteData()">åˆªé™¤é€™ä»½ä½œå“</button>
    </div>
</div>

<script>
    // ä½¿ç”¨æ–°çš„è³‡æ–™åº« Key é¿å…èˆ‡èˆŠéŒ¯èª¤è³‡æ–™è¡çª
    const DB_KEY = 'mizai_final_v6';
    let projects = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    let currentType = 'é‰¤é‡';
    let editingId = null;
    let tempImgs = []; 

    function switchTab(type) {
        currentType = type;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText.includes(type)));
        renderWall();
    }

    function renderWall() {
        const grid = document.getElementById('project-grid');
        const list = projects.filter(p => p.type === currentType);
        if (list.length === 0) {
            grid.innerHTML = `<div style="grid-column:1/3; text-align:center; padding:50px 0; color:#ccc;">å°šç„¡ç´€éŒ„</div>`;
            return;
        }
        grid.innerHTML = list.map(p => `
            <div class="card" onclick="openDetail(${p.id})">
                <img src="${(p.imgs && p.imgs[0]) ? p.imgs[0] : 'https://via.placeholder.com/150'}" class="card-img" loading="lazy">
                <div class="card-info">${p.title}</div>
            </div>
        `).join('');
    }

    async function processImages(input) {
        if (!input.files.length) return;
        
        const saveBtn = document.getElementById('save-btn');
        const status = document.getElementById('status-msg');
        saveBtn.disabled = true;
        status.style.display = 'block';

        const files = Array.from(input.files).slice(0, 5);
        tempImgs = []; 

        for (let file of files) {
            try {
                const base64 = await resizeImage(file);
                tempImgs.push(base64);
            } catch (err) {
                console.error("åœ–ç‰‡è™•ç†å¤±æ•—", err);
            }
        }
        
        updateGalleryUI();
        saveBtn.disabled = false;
        status.style.display = 'none';
    }

    function resizeImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400; // å¼·åŠ›å£“ç¸®å¯¬åº¦
                    const scale = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.5)); // é™ä½ç•«è³ªç¯€çœç©ºé–“
                };
            };
        });
    }

    function updateGalleryUI() {
        const box = document.getElementById('img-gallery-box');
        box.innerHTML = tempImgs.map(src => `<img src="${src}" class="gallery-item">`).join('') || '
