<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¹”è­œç´€éŒ„ç‰† v4</title>
    <style>
        :root { --p: #efa8b8; --s: #8fb6d9; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        .header-box { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tabs { display: flex; border-radius: 10px; overflow: hidden; border: 1px solid #ddd; margin-top: 10px; }
        .tab { flex: 1; padding: 10px; cursor: pointer; background: white; color: #666; font-size: 14px; }
        .tab.active { background: #333; color: white; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; display: block; }
        .card-info { padding: 8px; text-align: center; }
        .card-title { font-size: 14px; font-weight: bold; color: #333; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; min-height: 100%; width: 100%; padding: 20px; box-sizing: border-box; }
        .detail-img { width: 100%; border-radius: 10px; margin-bottom: 15px; }
        input, textarea, select { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 15px; border-radius: 10px; border: none; font-weight: bold; }
        .btn-save { background: #333; color: white; }
        .btn-cancel { background: #eee; color: #666; }
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--p); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 99; }
    </style>
</head>
<body>

<div class="header-box">
    <h2 style="margin:0; color:#444;">ğŸ§¶ ç¹”è­œæ—¥èªŒ</h2>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('é‰¤é‡')">é‰¤é‡</div>
        <div class="tab" onclick="switchTab('æ£’é‡')">æ£’é‡</div>
    </div>
</div>

<div class="grid" id="project-grid"></div>
<button class="fab" onclick="openAdd()">+</button>

<div id="modal">
    <div class="modal-content">
        <h3 id="m-header">ä½œå“è©³æƒ…</h3>
        <input type="text" id="m-title" placeholder="ä½œå“åç¨±">
        <select id="m-type">
            <option value="é‰¤é‡">é¡åˆ¥ï¼šé‰¤é‡</option>
            <option value="æ£’é‡">é¡åˆ¥ï¼šæ£’é‡</option>
        </select>
        <div id="img-preview-box"></div>
        <input type="file" id="m-img" accept="image/*" onchange="processImg(this)">
        <textarea id="m-steps" rows="6" placeholder="è£½ä½œæ­¥é©Ÿ..."></textarea>
        <textarea id="m-notes" rows="4" placeholder="å‚™è¨» (ç·šæã€é‡è™Ÿ)..."></textarea>
        <div class="btn-group">
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveData()">å„²å­˜</button>
        </div>
        <button id="del-btn" style="width:100%; margin-top:15px; color:red; border:none; background:none;" onclick="deleteData()">åˆªé™¤æ­¤ä½œå“</button>
    </div>
</div>

<script>
    let projects = JSON.parse(localStorage.getItem('knit_db_v4')) || [];
    let currentType = 'é‰¤é‡';
    let editingId = null;
    let tempImgBase64 = "";

    function switchTab(type) {
        currentType = type;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText === type));
        renderWall();
    }

    function renderWall() {
        const grid = document.getElementById('project-grid');
        const list = projects.filter(p => p.type === currentType);
        grid.innerHTML = list.length ? list.map(p => `
            <div class="card" onclick="openDetail(${p.id})">
                <img src="${p.img || 'https://via.placeholder.com/150'}" class="card-img">
                <div class="card-info"><div class="card-title">${p.title}</div></div>
            </div>
        `).join('') : '<p style="grid-column: 1/3; text-align:center; color:#999; margin-top:30px;">å°šç„¡ç´€éŒ„ï¼Œé»æ“Šå³ä¸‹æ–¹ + æ–°å¢</p>';
    }

    function processImg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600; // å£“ç¸®å¯¬åº¦è‡³ 600px ç¢ºä¿ä¸è¶…éå„²å­˜é™åˆ¶
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    tempImgBase64 = canvas.toDataURL('image/jpeg', 0.7); // å£“ç¸®ç•«è³ªç‚º 0.7
                    document.getElementById('img-preview-box').innerHTML = `<img src="${tempImgBase64}" class="detail-img">`;
                };
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveData() {
        const title = document.getElementById('m-title').value.trim();
        if (!title) { alert("è«‹è¼¸å…¥ä½œå“åç¨±"); return; }

        const data = {
            id: editingId || Date.now(),
            title: title,
            type: document.getElementById('m-type').value,
            steps: document.getElementById('m-steps').value,
            notes: document.getElementById('m-notes').value,
            img: tempImgBase64
        };

        try {
            if (editingId) {
                const idx = projects.findIndex(p => p.id === editingId);
                projects[idx] = data;
            } else {
                projects.push(data);
            }
            localStorage.setItem('knit_db_v4', JSON.stringify(projects));
            closeModal();
            renderWall();
        } catch (e) {
            alert("å„²å­˜å¤±æ•—ï¼šå¯èƒ½æ˜¯åœ–ç‰‡å¤ªå¤§æˆ–æ‰‹æ©Ÿç©ºé–“ä¸è¶³ã€‚");
            console.error(e);
        }
    }

    function openAdd() {
        editingId = null; tempImgBase64 = "";
        document.getElementById('m-header').innerText = "æ–°å¢ä½œå“";
        document.getElementById('m-title').value = "";
        document.getElementById('m-steps').value = "";
        document.getElementById('m-notes').value = "";
        document.getElementById('img-preview-box').innerHTML = "";
        document.getElementById('del-btn').style.display = 'none';
        document.getElementById('modal').style.display = 'block';
    }

    function openDetail(id) {
        editingId = id;
        const p = projects.find(item => item.id === id);
        document.getElementById('m-header').innerText = "ç·¨è¼¯è©³æƒ…";
        document.getElementById('m-title').value = p.title;
        document.getElementById('m-type').value = p.type;
        document.getElementById('m-steps').value = p.steps;
        document.getElementById('m-notes').value = p.notes;
        tempImgBase64 = p.img;
        document.getElementById('img-preview-box').innerHTML = p.img ? `<img src="${p.img}" class="detail-img">` : "";
        document.getElementById('del-btn').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
    }

    function deleteData() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) {
            projects = projects.filter(p => p.id !== editingId);
            localStorage.setItem('knit_db_v4', JSON.stringify(projects));
            closeModal();
            renderWall();
        }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    renderWall();
</script>

</body>
</html>
