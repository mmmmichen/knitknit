<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å’ªä»”ç¹”è­œç§˜ç¬ˆ</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    
    <style>
        :root { --p: #efa8b8; --text: #333; }
        body { font-family: -apple-system, sans-serif; background: #fafafa; margin: 0; padding-bottom: 100px; color: var(--text); -webkit-tap-highlight-color: transparent; }
        
        .header-box { background: white; padding: 20px 15px 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0 0 12px 0; font-size: 1.3rem; color: #444; letter-spacing: 1px; }
        .tabs { display: flex; border-radius: 20px; overflow: hidden; background: #eee; padding: 3px; }
        .tab { flex: 1; padding: 10px; cursor: pointer; border-radius: 18px; font-size: 14px; text-align: center; }
        .tab.active { background: #333; color: white; font-weight: bold; }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 15px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #f0f0f0; display: block; }
        .card-info { padding: 10px; text-align: center; font-size: 14px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; z-index: 10; }
        .modal-body { padding: 20px; padding-bottom: 60px; }

        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; }
        #lightbox-img { max-width: 95%; max-height: 85%; object-fit: contain; border-radius: 5px; }

        .view-title { font-size: 1.5rem; margin-bottom: 15px; font-weight: bold; }
        .view-section { margin-bottom: 25px; }
        .view-label { font-size: 13px; color: var(--p); font-weight: bold; margin-bottom: 8px; display: block; }
        .view-content { line-height: 1.7; white-space: pre-wrap; font-size: 16px; background: #fcfcfc; padding: 12px; border-radius: 10px; border: 1px solid #eee; }
        
        .img-gallery { display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; margin-bottom: 20px; }
        .view-gallery-item { width: 130px; height: 130px; flex-shrink: 0; object-fit: cover; border-radius: 12px; border: 1px solid #eee; }

        .edit-img-container { position: relative; flex-shrink: 0; width: 100px; text-align: center; }
        .edit-gallery-item { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .img-del-btn { position: absolute; top: -8px; right: -8px; background: #ff7675; color: white; border-radius: 50%; width: 22px; height: 22px; border: none; font-size: 12px; font-weight: bold; }
        .img-move-btns { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .move-btn { background: #eee; border: none; border-radius: 4px; padding: 2px 8px; font-size: 12px; color: #666; }

        label { font-size: 13px; color: #999; font-weight: bold; margin-top: 15px; display: block; }
        input, textarea, select { width: 100%; margin: 8px 0; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #fafafa; }
        
        .btn-round { padding: 8px 20px; border-radius: 20px; border: none; font-weight: bold; }
        .btn-edit { background: var(--p); color: white; }
        .btn-save { background: #333; color: white; width: 100%; padding: 15px; font-size: 16px; margin-top: 20px; border-radius: 12px; font-weight: bold; }
        .btn-close { background: none; font-size: 28px; color: #999; border: none; }
        
        .fab { position: fixed; bottom: 30px; right: 25px; width: 60px; height: 60px; background: var(--p); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; box-shadow: 0 4px 15px rgba(239,168,184,0.4); z-index: 500; }
        
        .system-tools { margin-top: 50px; padding: 20px; border-top: 1px solid #eee; text-align: center; }
        .sys-btn { display: inline-block; background: #f0f0f0; color: #888; border: none; padding: 10px 15px; border-radius: 8px; font-size: 12px; margin: 5px; text-decoration: none; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="header-box">
    <h1>ğŸ§¶ å’ªä»”ç¹”è­œç§˜ç¬ˆ</h1>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('é‰¤é‡')">é‰¤é‡ä½œå“</div>
        <div class="tab" onclick="switchTab('æ£’é‡')">æ£’é‡ä½œå“</div>
    </div>
</div>

<div class="grid" id="project-grid"></div>
<button class="fab" onclick="openAdd()">+</button>

<div class="system-tools">
    <p style="font-size: 12px; color: #ccc; margin-bottom: 10px;">ç³»çµ±å·¥å…·ï¼ˆæ›´æ›è¨­å‚™æˆ–å‚™ä»½ç”¨ï¼‰</p>
    <button class="sys-btn" onclick="exportData()">ğŸ’¾ å‚™ä»½æ‰€æœ‰ç¹”è­œ</button>
    <button class="sys-btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ é‚„åŸ/åŒ¯å…¥å‚™ä»½</button>
    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
</div>

<div id="lightbox" onclick="this.style.display='none'"><img id="lightbox-img" src=""></div>

<div id="modal">
    <div class="modal-header">
        <button class="btn-close" onclick="closeModal()">Ã—</button>
        <div id="modal-nav-btns"></div>
    </div>
    <div class="modal-body">
        <div id="view-mode">
            <div id="v-imgs" class="img-gallery"></div>
            <div id="v-title" class="view-title"></div>
            <div class="view-section"><span class="view-label">è£½ä½œæ­¥é©Ÿ</span><div id="v-steps" class="view-content"></div></div>
            <div class="view-section"><span class="view-label">å‚™è¨»</span><div id="v-notes" class="view-content"></div></div>
        </div>

        <div id="edit-mode" class="hidden">
            <label>ç®¡ç†ç…§ç‰‡ (æœ€å¤š 3 å¼µ)ï¼š</label>
            <div id="e-img-preview" class="img-gallery" style="background: #fdfdfd; border: 1px dashed #ccc; border-radius: 10px; min-height: 140px; align-items: center;"></div>
            <input type="file" id="e-file" accept="image/*" multiple onchange="processImages(this)">
            <label>ä½œå“åç¨±ï¼š</label><input type="text" id="e-title">
            <label>é¡åˆ¥ï¼š</label><select id="e-type"><option value="é‰¤é‡">é‰¤é‡</option><option value="æ£’é‡">æ£’é‡</option></select>
            <label>è£½ä½œæ­¥é©Ÿï¼š</label><textarea id="e-steps" rows="10"></textarea>
            <label>å‚™è¨»ï¼š</label><textarea id="e-notes" rows="4"></textarea>
            <button class="btn-save" id="save-btn" onclick="saveData()">å„²å­˜ä¿®æ”¹å…§å®¹</button>
            <button id="del-btn" style="width:100%; margin-top:30px; color:#ff7675; border:none; background:none; font-size:13px;" onclick="deleteData()">åˆªé™¤é€™ä»½ç§˜ç¬ˆ</button>
        </div>
    </div>
</div>

<script>
    // è¨»å†Š Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed:', err));
        });
    }

    const DB_KEY = 'mizai_v10';
    let projects = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    let currentType = 'é‰¤é‡';
    let editingId = null;
    let tempImgs = []; 

    function switchTab(type) {
        currentType = type;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText === type + 'ä½œå“'));
        renderWall();
    }

    function renderWall() {
        const grid = document.getElementById('project-grid');
        const list = projects.filter(p => p.type === currentType);
        grid.innerHTML = list.length ? list.map(p => `
            <div class="card" onclick="openDetail(${p.id})">
                <img src="${(p.imgs && p.imgs[0]) ? p.imgs[0] : 'https://via.placeholder.com/300'}" class="card-img">
                <div class="card-info">${p.title}</div>
            </div>
        `).join('') : '<div style="grid-column:1/3; text-align:center; padding:50px 0; color:#ccc;">å°šç„¡ç´€éŒ„</div>';
    }

    function openDetail(id) {
        editingId = id;
        const p = projects.find(item => item.id === id);
        if (!p) return;
        document.getElementById('v-title').innerText = p.title;
        document.getElementById('v-steps').innerText = p.steps || "ç„¡å…§å®¹";
        document.getElementById('v-notes').innerText = p.notes || "ç„¡å…§å®¹";
        document.getElementById('v-imgs').innerHTML = (p.imgs || []).map(src => `<img src="${src}" class="view-gallery-item" onclick="showBig('${src}')">`).join('');
        document.getElementById('modal-nav-btns').innerHTML = `<button class="btn-round btn-edit" onclick="toggleEditMode(true)">ç·¨è¼¯</button>`;
        toggleEditMode(false);
        document.getElementById('modal').style.display = 'block';
    }

    function showBig(src) {
        document.getElementById('lightbox-img').src = src;
        document.getElementById('lightbox').style.display = 'flex';
    }

    function toggleEditMode(isEdit) {
        const viewArea = document.getElementById('view-mode'), editArea = document.getElementById('edit-mode');
        if (isEdit) {
            viewArea.classList.add('hidden'); editArea.classList.remove('hidden');
            document.getElementById('modal-nav-btns').innerHTML = `<button class="btn-round" style="background:#eee" onclick="toggleEditMode(false)">å–æ¶ˆ</button>`;
            const p = projects.find(item => item.id === editingId) || { title:'', type:currentType, steps:'', notes:'', imgs:[] };
            document.getElementById('e-title').value = p.title;
            document.getElementById('e-type').value = p.type;
            document.getElementById('e-steps').value = p.steps;
            document.getElementById('e-notes').value = p.notes;
            tempImgs = [...(p.imgs || [])];
            renderEditGallery();
        } else {
            viewArea.classList.remove('hidden'); editArea.classList.add('hidden');
            if (editingId) document.getElementById('modal-nav-btns').innerHTML = `<button class="btn-round btn-edit" onclick="toggleEditMode(true)">ç·¨è¼¯</button>`;
        }
    }

    function renderEditGallery() {
        const box = document.getElementById('e-img-preview');
        if (tempImgs.length === 0) { box.innerHTML = '<span style="color:#ccc; font-size:13px; margin:auto;">å°šæœªé¸æ“‡ç…§ç‰‡</span>'; return; }
        box.innerHTML = tempImgs.map((src, idx) => `
            <div class="edit-img-container">
                <img src="${src}" class="edit-gallery-item">
                <button class="img-del-btn" onclick="removeImg(${idx})">Ã—</button>
                <div class="img-move-btns">
                    <button class="move-btn" onclick="moveImg(${idx}, -1)">â†</button>
                    <button class="move-btn" onclick="moveImg(${idx}, 1)">â†’</button>
                </div>
            </div>
        `).join('');
    }

    function removeImg(idx) { tempImgs.splice(idx, 1); renderEditGallery(); }
    function moveImg(idx, dir) {
        const newIdx = idx + dir;
        if (newIdx < 0 || newIdx >= tempImgs.length) return;
        const [target] = tempImgs.splice(idx, 1);
        tempImgs.splice(newIdx, 0, target);
        renderEditGallery();
    }

    async function processImages(input) {
        const files = Array.from(input.files);
        const toProcess = files.slice(0, 3 - tempImgs.length);
        if (toProcess.length === 0 && files.length > 0) alert("æœ€å¤š 3 å¼µç…§ç‰‡å–”ï¼");
        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true; saveBtn.innerText = "è™•ç†ä¸­...";

        for (let file of toProcess) {
            const base64 = await new Promise(resolve => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * (MAX_WIDTH / img.width);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
            tempImgs.push(base64);
        }
        renderEditGallery();
        saveBtn.disabled = false; saveBtn.innerText = "å„²å­˜ä¿®æ”¹å…§å®¹";
    }

    function saveData() {
        const title = document.getElementById('e-title').value.trim();
        if (!title) return alert("è«‹å¡«å¯«ä½œå“åç¨±");
        const data = { id: editingId || Date.now(), title, type: document.getElementById('e-type').value, steps: document.getElementById('e-steps').value, notes: document.getElementById('e-notes').value, imgs: tempImgs };
        const idx = projects.findIndex(p => p.id === editingId);
        if (idx > -1) projects[idx] = data; else projects.push(data);
        localStorage.setItem(DB_KEY, JSON.stringify(projects));
        openDetail(data.id); renderWall();
    }

    function exportData() {
        const dataStr = JSON.stringify(projects);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `mizai_backup_${new Date().toLocaleDateString()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (Array.isArray(imported)) {
                    if (confirm("é‚„åŸå°‡æœƒè¦†è“‹ç›®å‰æ‰‹æ©Ÿå…§çš„è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                        projects = imported;
                        localStorage.setItem(DB_KEY, JSON.stringify(projects));
                        renderWall();
                        alert("é‚„åŸæˆåŠŸï¼");
                    }
                } else { alert("å‚™ä»½æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º"); }
            } catch (err) { alert("è®€å–æª”æ¡ˆå¤±æ•—"); }
        };
        reader.readAsText(file);
    }

    function openAdd() { editingId = null; tempImgs = []; toggleEditMode(true); document.getElementById('del-btn').style.display = 'none'; document.getElementById('modal').style.display = 'block'; }
    function deleteData() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { projects = projects.filter(p => p.id !== editingId); localStorage.setItem(DB_KEY, JSON.stringify(projects)); closeModal(); renderWall(); } }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    renderWall();
</script>

</body>
</html>
